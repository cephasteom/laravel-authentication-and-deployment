## Learning Objectives
- Understand how an API checks your credentials
- Be able to setup Laravel Passport to handle request authorisation
- Update your API to authorise chosen routes

## Key Language

## Authorisation
APIs typically use tokens to authenticate users. The process is as follows:
- The user makes a request to a dedicated authorisation endpoint, providing credentials such as username password
- The API checks whether these credentials are valid
- If valid, send back a token unique to your user
- The user makes all future requests supplying the token in the header
- The API accepts the request, checks the validity of the token and brings up the user's data if valid
- The API is able to grant or deny requests based on whether the user is valid and who the user is

### Installation
Install Laravel Passport
````
composer require laravel/passport
````

Create database tables to store access tokens in (vagrant ssh)
````
artisan migrate
````

Install Laravel Passport
````
artisan passport:install
````

Make a note of the password grant Client ID and Client Secret that get printed out following successful installation. Something like:
````
...
Password grant client created successfully.
Client ID: 2
Client secret: QtE4syo8QFwvw4bMEK5Ej2zaJ3jgF3RYmF1JjZmU
````

In App/User.php add the HasApiTokens trait:
````
use Laravel\Passport\HasApiTokens;
...

class User extends Authenticatable
{
    use HasApiTokens,Notifiable;
    ...
}
````


In AuthServiceProvider.php use the Passport class to add necessary routes to your app  
````
use Laravel\Passport\Passport;
...
class AuthServiceProvider extends ServiceProvider
{
	...
	public function boot()
    {
    	...
    	Passport::routes();
    }
}
````

Finally, in config/auth.php config file, set the driver of the api authentication guard to 'passport'  
````
'guards' => [
    ...

    'api' => [
        'driver' => 'passport',
        'provider' => 'users',
    ],
],
````


Create single user on the command line...
````
artisan tinker
App\User::create(array('name' => 'admin', 'email' => 'admin@admin.com', 'password' => Hash::make('password')));
````

You should now be able to make a request in Postman to POST `http://homestead.test/oauth/token` with the body:  
````
{
	"grant_type": "password"
	"client_id": "2",
	"client_secret": "OTXeJFxNTHLDuMnsHgu5pAmpnMv1YMM98AY4oyM4",
	"username": "admin@admin.com",
	"password": "password"
}
````
If everything is setup correctly, the token that gets returned can be stored then sent as a Bearer Token with each following request.

### Simple authentication

If a valid access token is sufficient authentication, Laravel provides some simple methods to be used in your routes file (routes/api.php):

#### Single route
Add the `auth:api` middleware to any routes that require a valid access token:
````
$router->get("", "Articles@index")->middleware('auth:api');
````
Try calling `GET http://homestead.test/api/articles` in Postman (remember to add the header `Accept: application/json`). You should get a 401 response.

This time choose `Bearer Token` in the Authorization tab and paste in the access token you got back from the `oauth/token` endpoint. 

#### Groups
To add authentication to the entire group:  
````
$router->group(["prefix" => "articles", "middleware" => ["auth:api"]], function ($router) {
	...
}
````

### More complex authentication
In reality our blog api probably needs different levels of authentication. Posts should be open to anyone but, only the owner of the blog should be able to write and edit blog posts, and only logged in users should be able to comment.

This suggests two types of user - a site `Admin` and any number of `Subscribers`. Our next job is to be able to store two different types of user in our database.
