TODO: compile these notes, they're a mess...
TODO: change the document root
This can be done in this file:
/opt/bitnami/apache2/conf/bitnami/bitnami.conf

https://docs.bitnami.com/aws/infrastructure/lamp/get-started/use-laravel/

progress-api
- remember once setup to run php artisan passport:install

Application and mysql password
B2rC7ei1bEMT

scp datadump
scp -i ~/.ssh/aws-key-pair.pem db.sql bitnami@ec2-18-130-57-88.eu-west-2.compute.amazonaws.com:/opt/bitnami/apache2/htdocs

ssh in
ssh -i ~/.ssh/aws-key-pair.pem bitnami@ec2-18-130-57-88.eu-west-2.compute.amazonaws.com

## Learning Objectives
- Understand an overview of how a project is setup on a server
- Be able to follow a process to host a Laravel project on an AWS EC2
- Be able to reason about what you are doing

## Key Language
- SSH
- SSH keys
- Linux
- Apache
- Mysql
- PHP
- Composer
- Git
- AWS
- EC2
- Virtual server
- HTTP

## Overview
There are many ways to deploy your Laravel API - many of them highly automated, efficient and pain free. Even though it's a slighly more involved process, we're going to use an LAMP Certified by Bitnami AMI server for the following reasons:
- It's free (up to a point)
- It looks and feels like your Vagrant box
- It can be setup to use the same stack as your Vagrant box

### What is AWS?
AWS (Amazon Web Services) provide a dizzying array of cloud-computing services on a pay as you go basis. These include computing, storage, networking, databases... The most popular of these include Elastic Cloud Computing (EC2) and Simple Storage Service (S3).

### What is EC2
Elastic Cloud Computing is a service that allows you to spin up virtual computers to deploy your applications, rather than having to invest in hardware. They are elastic as they can be configured to scale up or down depending on traffic.

### SSH
Overview of how local machine, server and Git repository are connected and can communicate.

## Deployment
### Prerequisites
- An AWS account
- An EC2 SSH key pair  

To create an EC2 SSH key pair follow the instructions in [this document](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#having-ec2-create-your-key-pair) (make sure you create it in your home region (e.g. EU-London):

### Launching your server
- Login to AWS, go to EC2, make sure you’re on the EU London region (top right of the nav).
- Launch Instance
- Choose - LAMP Certified by Bitnami
- Choose - T2.micro
- Go to Add tags - Add tag - `key=Name value=my-server-name` (this is so you can identify it in the dashboard)
- Click Launch
- Select your existing keypair
- When this has loaded up, go back to the EC2 console. You should see an instance running, with the name you gave it.

Sense Check! Copy the Public DNS (IPv4) record in the instance info into a browser window. You should see a Congratulations page.

### Accessing your server

SSH into your server
````
ssh username@domain.of.your.instance
````

For an amazon linux instance the username is ec2-user and the domain can be found by clicking on your instance in the EC2 dashboard and copying the Public DNS (IPv4). It should something look like this:
````
ssh ec2-user@ec2-3-8-39-24.eu-west-2.compute.amazonaws.com
````

Sidenote: If the ssh-key-pair you’ve used to authenticate with diverges from the usual id_rsa naming you can specify the exact name of your key pair using the `-i` flag.
````
ssh -i ~/.ssh/aws-key-pair.pem ec2-user@ec2-3-8-125-57.eu-west-2.compute.amazonaws.com
````

#### Install server dependencies
- Apache - HTTP server software
- Mysql - database management system
- PHP - programming language
- Git - file management
- Composer - php package manager
- SSH keys - for authentication
- Apache, PHP, Mysql and Git

<!-- Update yum (used for installing linux packages)
````
sudo yum update -y
````
Install Apache, PHP and mysql
````
sudo yum install -y httpd24 php72 mysql56-server php72-mysqlnd
````
Install a php package used by Laravel
````
sudo yum install php72-mbstring
````
Install git
````
sudo yum install git
````
Install Composer
````
cd ~
sudo curl -sS https://getcomposer.org/installer | sudo php
sudo mv composer.phar /usr/local/bin/composer
sudo ln -s /usr/local/bin/composer /usr/bin/composer
````
Start apache and configure it so it always starts on boot
````
sudo service httpd start
sudo chkconfig httpd on
````
Sense Check! Checkout your server in the browser (in the EC2 dashboard - copy the Public DNS (IPv4)). You should see an Apache test page. -->
Change document root
Found in /opt/bitnami/apache2/conf/httpd.conf
DocumentRoot "/home/bitnami/htdocs"
<Directory "/home/bitnami/htdocs">

### Ownership

By default, the files on this machine image are served from the folder `/opt/bitnami/apache2/htdocs`. This is like your public folder in a vagrant box.

Let's remove the existing contents of `/opt/bitnami/apache2/htdocs`:
````
rm -rf /opt/bitnami/apache2/htdocs && mkdir /opt/bitnami/apache2/htdocs
````

Then, let's create our own file in here:
````
cd /opt/bitnami/apache2/htdocs
touch index.html
````

<!-- You should get the message `touch: cannot touch ‘index.html’: Permission denied`.

This is because, by default, all files on the server are owned by the root user. 
Let’s take ownership of this folder so that we can make changes:
````
sudo chown -R ec2-user /var/www/html/
```` -->

Create an index page on your server
````
touch index.html
````
Open the file in a code editor
````
nano index.html
````
Add 
````
<h1>hello world</h1>
````
then `ctrl+x` and save.

Sense Check! Checkout your server in the browser. This should now read Hello World. This is because your browser looks for an index.html file on your server and serves it up.

Remove the index.html file
````
rm index.html
````

### Deploy files to the server using Git
TODO: deploy keys

How does git know that the server requesting access to the repo is authorised? Just as you have ssh keys on your machine and with a matching public key in Github, your server needs the same.

#### Generate keys on your server instance
Create a key on the server (substitute the email for the best email to contact you on. This helps your successor when they come to clean up random keys left on the server).
````
ssh-keygen -t rsa -b 4096 -C "<your_email_address>"
````
Hit enter at all prompts

You should now be able to see this key pair in the folder
````
cd ~/.ssh && ls
````

Start ssh agent
````
eval "$(ssh-agent -s)"
````
Add private key to ssh-agent
````
ssh-add ~/.ssh/id_rsa
````
View your public key
````
cat ~/.ssh/id_rsa.pub
````
Select the output and copy to the clipboard

#### Upload the key to github

In github, go to top right profile picture, click settings, in side bar click SSH and GPG keys, new ssh key, paste in key and give a sensible title about where this lives, such as the name of the server.

You should now be able to connect to git from the server

#### Copy your repository to the server
On your repository, go to clone or download and, as usual, copy the code (ensure it says clone with SSH)
````
cd /opt/bitnami/apache2/htdocs
git init
git remote add origin git@github.com:your-name/repo-name.git
git fetch
git checkout master
composer install
````
<!-- If you get an error message to say you’ve run out of memory, try stopping apache, run composer again then restart apache
````
sudo service httpd stop
composer install
sudo service httpd start -->
<!-- ```` -->
#### Laravel specific steps

Go back to the page in the browser, you should still see the apache test page - why is this? Your laravel project is actually served out of the public folder, whereas your server is setup to look for an index page at /var/www/html. So, we need to tell the server where the project root is.

Open the Apache config file in a text editor
````
sudo nano /etc/httpd/conf/httpd.conf
````

Scroll down to document root and change it to
````
DocumentRoot "/var/www/html/public"
````
And
````
# Further relax access to the default document root:
<Directory "/var/www/html/public">
	…
	AllowOverride All
````

Reboot apache
````
sudo service httpd restart
````

Sense check: check out the page in your browser. The apache test message should have disappeared and everything should be broken. Congratulations, we have made progress!


You are missing your .env file with your laravel key in there. Create a new .env file and paste the contents of your existing .env into it.
````
sudo nano /var/www/html/.env
````
Exit and save.

Sense check: check out the page in your browser. The page should now display a Laravel error message. This is because Laravel writes logs about it’s activity. All of the files in /var/www/html belong to you, so Apache is unable to write into the logs.

Give Apache permission to write in this folder
````
<!-- setfacl -R -m u:apache:rwX storage/ -->
sudo chmod -R 777 storage/*
````

Sense check: check out the page in your browser. You should now see the laravel homepage!

### Setting up the database

#### Setup Mysql
<!-- Start mysql client
````
sudo service mysqld start
````

Set password and configure Mysql
````
sudo mysql_secure_installation
````

- Press enter when asked about the current password
- Type Y to set a new password and enter and re-enter to confirm
- Answer Y to all further questions

Get mysql to start at every boot
````
sudo chkconfig mysqld on
```` -->
Access mysql
````
mysql -u root -p
````
password can be found by going to the instance in EC2 console, right click on name > instance settings > Get system log. Look for password in # box

````
mysql > create database laravel
mysql > exit
````

#### Setup Laravel
Update your .env file with the details of your database (the name of the database and password you created as well as changing user to root)
````
sudo nano .env
````
````
DB_CONNECTION=mysql
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=laravel
DB_USERNAME=root
DB_PASSWORD=<your_password>
````
Use artisan to build your database
````
php artisan migrate
````

<!-- Sidenote: If you encounter issues with maximum key length exceeded you can override this in app/Provider/AppServiceProvider.js.

````
sudo nano /var/www/html/app/Providers/AppServiceProvider.php
````

Add the following code to the top of the file
````
use Illuminate\Support\Facades\Schema;
````
Add the following code in the boot method
````
public function boot()
{
    Schema::defaultStringLength(191);
}
````
In Mysql delete the database and start again
```` -->
<!-- mysql -u root -p
````
````
mysql > drop database laravel
mysql > create database laravel
mysql > exit
```` -->
Use artisan migrate your database
````
php artisan migrate
````
Success everything is setup!! You should now be able to make calls to your API.